{% extends 'base.html' %}
{% block title %}Envoyer un message{% endblock %}
{% block content %}
<div class="messaging-container">
    <div class="chat-wrapper">
        <!-- Header avec effet de verre -->
        <div class="chat-header glass-effect">
            <div class="recipient-info">
                <div class="avatar pulse-animation">
                    <img src="https://ui-avatars.com/api/?name={{ recipient.username }}&background=random" alt="{{ recipient.username }}">
                </div>
                <h2>Discussion avec {{ recipient.username }}</h2>
            </div>
            <a href="{% url 'profile' recipient.username %}" class="profile-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
                Profil
            </a>
        </div>

        <!-- Messages avec effet de dégradé -->
        <div class="messages-container" id="messages">
            {% for message in messages %}
                <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}">
                    <div class="message-content">
                        <p>{{ message.content }}</p>
                        <span class="message-time">{{ message.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
            {% endfor %}
            {% if not messages %}
                <div class="no-messages">
                    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                    </svg>
                    <p>Commencez la conversation avec {{ recipient.username }}</p>
                </div>
            {% endif %}
        </div>

        <!-- Formulaire avec effet de néon -->
        <form method="post" id="message-form" class="message-form floating-effect">
            {% csrf_token %}
            <div class="input-wrapper">
                {{ form.content }}
                <button type="submit" class="send-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.5.5 0 0 1-.928.086L7.5 12.5l-4.486 3.558a.5.5 0 0 1-.698-.069L.146 13.354a.5.5 0 0 1 .054-.706L12.5 7.5l4.156-5.101a.5.5 0 0 1 .198-.049z"/>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --sent-color: #4cc9f0;
        --received-color: #f0f0f0;
        --glass-bg: rgba(255, 255, 255, 0.25);
        --glass-border: rgba(255, 255, 255, 0.18);
    }

    .messaging-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
        height: calc(100vh - 100px);
        display: flex;
        flex-direction: column;
    }

    .chat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        overflow: hidden;
    }

    /* Header avec effet de verre */
    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--glass-border);
        z-index: 10;
    }

    .glass-effect {
        background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .recipient-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border-radius: 50px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .profile-btn:hover {
        background: var(--secondary-color);
        transform: translateY(-2px);
    }

    /* Zone de messages */
    .messages-container {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(to bottom, #f5f7fa, #e8ebf0);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message-bubble {
        max-width: 70%;
        padding: 0.8rem 1.2rem;
        border-radius: 1.5rem;
        position: relative;
        animation: fadeInUp 0.4s ease-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .message-bubble.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--sent-color), #4895ef);
        color: white;
        border-bottom-right-radius: 0.3rem;
    }

    .message-bubble.received {
        align-self: flex-start;
        background: white;
        border-bottom-left-radius: 0.3rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-content p {
        margin: 0;
        line-height: 1.4;
    }

    .message-time {
        display: block;
        font-size: 0.7rem;
        opacity: 0.8;
        margin-top: 0.3rem;
        text-align: right;
    }

    .message-bubble.sent .message-time {
        color: rgba(255,255,255,0.8);
    }

    .message-bubble.received .message-time {
        color: #666;
    }

    .no-messages {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        text-align: center;
        animation: fadeIn 1s ease-in;
    }

    .no-messages svg {
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Formulaire de message */
    .message-form {
        padding: 1rem;
        background: white;
        border-top: 1px solid #eee;
    }

    .floating-effect {
        box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
    }

    .input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    #id_content {
        flex: 1;
        padding: 0.8rem 1.2rem;
        border-radius: 50px;
        border: 1px solid #ddd;
        outline: none;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    #id_content:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .send-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .send-btn:hover {
        background: var(--secondary-color);
        transform: scale(1.05) rotate(5deg);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .messaging-container {
            height: calc(100vh - 60px);
            padding: 0;
            margin: 0;
            border-radius: 0;
        }

        .chat-wrapper {
            border-radius: 0;
        }

        .message-bubble {
            max-width: 85%;
        }

        .chat-header {
            padding: 0.8rem 1rem;
        }

        .messages-container {
            padding: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Animation pour les nouveaux messages
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.classList && node.classList.contains('message-bubble')) {
                        node.style.animation = 'fadeInUp 0.4s ease-out';
                    }
                });
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        observer.observe(messagesDiv, { childList: true });

        // Envoi de message AJAX avec animation
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const input = this.querySelector('input[type="text"]');
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const newMessage = document.createElement('div');
                    newMessage.classList.add('message-bubble', 'sent');
                    newMessage.innerHTML = `
                        <div class="message-content">
                            <p>${data.content}</p>
                            <span class="message-time">${data.created_at}</span>
                        </div>`;
                    messagesDiv.appendChild(newMessage);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    input.value = '';
                    
                    // Ajout d'un effet sonore (optionnel)
                    const sound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
                    sound.volume = 0.3;
                    sound.play();
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}